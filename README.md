# VK Tunnel

Очень часто в веб-разработке требуется показать своё приложение другим пользователям. В случае боевой версии сайта беспокоиться не о чем, но если во время разработки вы пользуетесь локальным сервером, то показать промежуточные результаты на нём — нетривиальная задача.

Ещё сложнее становится в том случае, когда вам нужно проверить взаимодействие приложения с внешними инструментами, к примеру, с VK Bridge внутри мобильных приложений.

VK Tunnel — это утилита, которая позволит сделать сервер на вашем локальном компьютере публичным
После запуска VK Tunnel Вы можете отслеживать в терминале информацию о состоянии и показателях соединений, установленных через ваш туннель.

## Использование

Использование в VK Mini Apps
Установите пакет:

    npm install @vkontakte/vk-tunnel -g

Создайте приложение из шаблона:

    npx @vkontakte/create-vk-mini-app@latest <foldername>

Перейдите к папке проекта при помощи команды:

    cd <foldername>

Запустите проект командой:

    npm start

И сделайте вызов в консоли проекта:

    env NODE_TLS_REJECT_UNAUTHORIZED=0 \
    PROXY_HTTP_PROTO=https \
    PROXY_WS_PROTO=wss \
    PROXY_HOST=localhost \
    PROXY_PORT=10888 \
    PROXY_TIMEOUT=5000 \

Или, используя опции:

    vk-tunnel --insecure=1 --http-protocol=https --ws-protocol=wss --host=localhost --port=10888 --timeout=5000

В терминале будет предложено перейти по адресу в формате
`https://oauth.vk.com/code_auth?stage=check&code=2a2aaaa` для авторизации. Откройте ссылку в браузере, вернитесь в терминал и нажмите enter

После успешной авторизации в терминале появится ссылки вида

    https://user12345-jv7zlzzz.wormhole.vk-apps.com - для http соединения
    wss://user12345-jv7zlzzz.wormhole.vk-apps.com - для websocket соединения

Укажите http ссылку в поле URL в управлении Вашим мини-приложением для дальнейшей работы. Если приложение ещё не создано – воспользуйтесь инструкцией

## Переменные окружения

При запуске утилиты вы можете настроить переменные окружения:

| Переменная                   | Опция           | Описание                                                                                                                                                                                                  |
| ---------------------------- | --------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| NODE_TLS_REJECT_UNAUTHORIZED | --insecure      | флаг, позволяет пропустить проверку самоподписанных сертификатов <br>Возможные значения: <br>0 — пропустить проверку<br>1 — проверить сертификат (в случае, если передается через опцию, логика обратная) |
| PROXY_HTTP_PROTO             | --http-protocol | Схема для HTTP протокола<br>Возможные значения: <br>http — нешифрованное соединение <br>https — шифрованное соединение<br><br>Значение по умолчанию: http                                                 |
| PROXY_WS_PROTO               | --ws-protocol   | Схема для Web Socket-протокола<br>Возможные значения: <br>_ws_ — нешифрованное соединение <br>_wss_ — шифрованное соединение<br><br>Значение по умолчанию: _ws_                                           |
| PROXY_HOST                   | --host          | хост, на котором запущен проект<br>Значение по умолчанию: _localhost_                                                                                                                                     |
| PROXY_PORT                   | --port          | порт, на котором запущен Ваш проект<br>Значение по умолчанию: _10888_                                                                                                                                     |
| PROXY_TIMEOUT                | --timeout       | таймаут запросов к вашему приложению<br>Значение по умолчанию: _5000_                                                                                                                                     |

## Файл настроек `vk-tunnel-config.json`

Чтобы автоматически заменять адрес в [Настройках](https://dev.vk.com/mini-apps/management/settings) мини-приложения, создайте файл `vk-tunnel-config.json`. В нём укажите следующие параметры.

### `app_id`

Идентификатор мини-приложения. Обязательное поле.

### `endpoints`

Список платформ и групп тестировщиков, для которых нужно автоматически заменить адрес. Возможные значения:

- `mobile` — мобильное приложение.
- `mvk` — мобильная версия сайта.
- `web` — десктопная версия сайта.
- `testing_group:НАЗВАНИЕ_ГРУППЫ_ТЕСТИРОВЩИКОВ` — название [группы тестировщиков](https://dev.vk.com/mini-apps/management/testing), для которой нужно заменить адрес. Указать можно не более трёх групп. Если указать больше, то адрес не будет заменён ни для одной из групп.

### `опции`

Вы можете при необходимости вынести настройки севера в конфигурационный файл. При его использовании наибольший вес будут иметь опции, указанные при запуске скрипта, затем будут идти переменные окружения. Файл конфигурации имеет наименьший приоритет. Если какой то из параметров не передан, берется его значение по умолчанию.

Пример файла:

```JSON
{
    "app_id": "7293255",
    "endpoints": [
        "mobile",
        "mvk",
        "web",
        "testing_group:НАЗВАНИЕ_ТЕСТОВОЙ_ГРУППЫ_1",
        "testing_group:НАЗВАНИЕ_ТЕСТОВОЙ_ГРУППЫ_2"
    ],
    "port": "3000",
    "http-protocol": "https",
    "insecure": "0",
}
```

## Полезные ссылки

- [Примеры мини-приложений](https://dev.vk.com/mini-apps/examples)

- [Сообщество VK Mini Apps](https://vk.com/vkappsdev) — сообщество разработчиков мини-приложений ВКонтакте
